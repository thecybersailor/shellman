# Build Validation System
# Automated validation chain using Makefile's native dependency mechanism

.PHONY: validate-all validate-quick validate-clean validate-status validate-task-system validate-e2e-entry-guard
.PHONY: validate-api-types validate-cli-lint validate-cli-tests validate-worker-tests validate-webui-types validate-webui-tests
.PHONY: validate-webui-i18n-keys validate-webui-i18n-hardcoded

STATUS_DIR := .build-status
STATUS_API_TYPES := $(STATUS_DIR)/api-types.status
STATUS_CLI_LINT := $(STATUS_DIR)/cli-lint.status
STATUS_CLI_TESTS := $(STATUS_DIR)/cli-tests.status
STATUS_WORKER_TESTS := $(STATUS_DIR)/worker-tests.status
STATUS_WEBUI_TYPES := $(STATUS_DIR)/webui-types.status
STATUS_WEBUI_TESTS := $(STATUS_DIR)/webui-tests.status
STATUS_WEBUI_I18N_KEYS := $(STATUS_DIR)/webui-i18n-keys.status
STATUS_WEBUI_I18N_HARDCODED := $(STATUS_DIR)/webui-i18n-hardcoded.status

CLI_SRC_FILES := $(shell find cli -type f -name '*.go' 2>/dev/null)
CLI_SWAGGER_FILES := $(shell find cli/Makefile.swagger cli/scripts -type f 2>/dev/null)
WORKER_SRC_FILES := $(shell find ../edge/cloudflare -type f \( -name '*.ts' -o -name '*.js' -o -name 'package*.json' \) 2>/dev/null)
WEBUI_FILES := $(shell find webui/src webui/package.json webui/tsconfig*.json webui/vite.config.* webui/vitest*.config.* -type f 2>/dev/null)

$(STATUS_DIR):
	@mkdir -p $(STATUS_DIR)

validate-all: validate-e2e-entry-guard $(STATUS_API_TYPES) $(STATUS_CLI_LINT) $(STATUS_CLI_TESTS) $(STATUS_WORKER_TESTS) $(STATUS_WEBUI_TYPES) $(STATUS_WEBUI_I18N_KEYS) $(STATUS_WEBUI_I18N_HARDCODED) $(STATUS_WEBUI_TESTS)
	@echo ""
	@echo "‚úÖ All validations passed!"

validate-quick: validate-e2e-entry-guard $(STATUS_API_TYPES) $(STATUS_CLI_LINT) $(STATUS_CLI_TESTS) $(STATUS_WORKER_TESTS) $(STATUS_WEBUI_TYPES) $(STATUS_WEBUI_I18N_KEYS) $(STATUS_WEBUI_I18N_HARDCODED)
	@echo ""
	@echo "‚úÖ Quick validation passed!"

validate-clean:
	@echo "üßπ Cleaning validation status files..."
	@rm -rf $(STATUS_DIR)
	@echo "‚úÖ Cleaned"

validate-status:
	@echo "üìä Validation Status:"
	@echo ""
	@if [ -f $(STATUS_API_TYPES) ]; then echo "  ‚úì API Types"; else echo "  ‚úó API Types: Not validated"; fi
	@if [ -f $(STATUS_CLI_LINT) ]; then echo "  ‚úì CLI Lint"; else echo "  ‚úó CLI Lint: Not validated"; fi
	@if [ -f $(STATUS_CLI_TESTS) ]; then echo "  ‚úì CLI Tests"; else echo "  ‚úó CLI Tests: Not validated"; fi
	@if [ -f $(STATUS_WORKER_TESTS) ]; then echo "  ‚úì Worker Tests"; else echo "  ‚úó Worker Tests: Not validated"; fi
	@if [ -f $(STATUS_WEBUI_TYPES) ]; then echo "  ‚úì WebUI Types"; else echo "  ‚úó WebUI Types: Not validated"; fi
	@if [ -f $(STATUS_WEBUI_TESTS) ]; then echo "  ‚úì WebUI Tests"; else echo "  ‚úó WebUI Tests: Not validated"; fi
	@if [ -f $(STATUS_WEBUI_I18N_KEYS) ]; then echo "  ‚úì WebUI i18n Keys"; else echo "  ‚úó WebUI i18n Keys: Not validated"; fi
	@if [ -f $(STATUS_WEBUI_I18N_HARDCODED) ]; then echo "  ‚úì WebUI i18n Hardcoded"; else echo "  ‚úó WebUI i18n Hardcoded: Not validated"; fi

$(STATUS_API_TYPES): $(STATUS_DIR) $(CLI_SRC_FILES) $(CLI_SWAGGER_FILES)
	@echo "üîÑ Generating API types..."
	@cd cli && $(MAKE) -f Makefile.swagger swagger-sdk-localapi
	@touch $(STATUS_API_TYPES)
	@echo "‚úÖ API types generated"

validate-api-types: $(STATUS_API_TYPES)

$(STATUS_CLI_LINT): $(STATUS_DIR) $(CLI_SRC_FILES)
	@echo "üîÑ Running CLI lint..."
	@cd cli && $(MAKE) lint
	@touch $(STATUS_CLI_LINT)
	@echo "‚úÖ CLI lint validated"

validate-cli-lint: $(STATUS_CLI_LINT)

$(STATUS_CLI_TESTS): $(STATUS_DIR) $(CLI_SRC_FILES)
	@echo "üîÑ Running CLI tests..."
	@cd cli && go test ./...
	@touch $(STATUS_CLI_TESTS)
	@echo "‚úÖ CLI tests validated"

validate-cli-tests: $(STATUS_CLI_TESTS)

$(STATUS_WORKER_TESTS): $(STATUS_DIR) $(WORKER_SRC_FILES)
	@echo "üîÑ Running worker tests..."
	@cd ../edge/cloudflare && npm test
	@touch $(STATUS_WORKER_TESTS)
	@echo "‚úÖ Worker tests validated"

validate-worker-tests: $(STATUS_WORKER_TESTS)

$(STATUS_WEBUI_TYPES): $(STATUS_DIR) $(STATUS_API_TYPES) $(WEBUI_FILES)
	@echo "üîÑ Validating WebUI types..."
	@cd webui && npx vue-tsc --noEmit
	@touch $(STATUS_WEBUI_TYPES)
	@echo "‚úÖ WebUI types validated"

validate-webui-types: $(STATUS_WEBUI_TYPES)

$(STATUS_WEBUI_I18N_KEYS): $(STATUS_DIR) $(STATUS_WEBUI_TYPES) $(WEBUI_FILES)
	@echo "üîÑ Checking WebUI i18n keys..."
	@if [ ! -f "webui/src/locales/en.json" ]; then \
		echo "‚ùå Missing language file: webui/src/locales/en.json"; \
		exit 1; \
	fi
	@bun webui/scripts/check-i18n.mjs --mode keys --root webui/src --lang webui/src/locales/en.json
	@touch $(STATUS_WEBUI_I18N_KEYS)
	@echo "‚úÖ WebUI i18n key check passed"

validate-webui-i18n-keys: $(STATUS_WEBUI_I18N_KEYS)

$(STATUS_WEBUI_I18N_HARDCODED): $(STATUS_DIR) $(STATUS_WEBUI_TYPES) $(WEBUI_FILES)
	@echo "üîÑ Checking WebUI hardcoded strings..."
	@bun webui/scripts/check-i18n.mjs --mode hardcoded --root webui/src
	@touch $(STATUS_WEBUI_I18N_HARDCODED)
	@echo "‚úÖ WebUI hardcoded string check passed"

validate-webui-i18n-hardcoded: $(STATUS_WEBUI_I18N_HARDCODED)

$(STATUS_WEBUI_TESTS): $(STATUS_DIR) $(STATUS_WEBUI_TYPES) $(WEBUI_FILES)
	@echo "üîÑ Running WebUI tests..."
	@cd webui && npm test
	@touch $(STATUS_WEBUI_TESTS)
	@echo "‚úÖ WebUI tests validated"

validate-webui-tests: $(STATUS_WEBUI_TESTS)

validate-task-system:
	@./scripts/validate-task-system.sh

validate-e2e-entry-guard:
	@./scripts/validate-e2e-entry-guard.sh
